<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-audio-player/paper-audio-player.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">

<dom-module id="my-sample-view">
    <template>
        <style include="shared-styles">
            :host {
                display: block;
                padding: 5px;
                background-color: transparent;
            }
        </style>

        <div class="card">
            <paper-input id="file" label="file" type="file"></paper-input>
            <paper-input type=password id="pwd" label="account pwd"></paper-input>

            <paper-button raised on-tap="deploy">Deploy</paper-button>
            <p>ipfs hash: {{hash}}</p>
            <p>contract: {{contract}}</p>
            <p>status: {{status}}</p>
        </div>

        <!--<p>status: {{status}}</p>-->
    </template>

    <script>
        var request = require('request');
        var fs = require('fs');
        var Web3 = require('web3');
        var web3 = new Web3();
        web3.setProvider(new web3.providers.HttpProvider('http://localhost:8545'));

        Polymer({
            is: 'my-sample-view',
            deploy: function() {
                var that = this;
                var path = this.$.file.inputElement.value;
                var pwd = that.$.pwd.value;
                var coinsPerPlay = 1;
                var resourceKey = "dogandcatsdontgetalong";
                var fromAccount = web3.eth.accounts[0];
                ipfsAdd(this, path,
                    function(ipfsHash) {
                        that.status = "Added file to IPDF" + path + ", Deploying contract...";
                        that.hash = ipfsHash;
                        deployDummy(fromAccount, coinsPerPlay, "ipfs://" + ipfsHash, resourceKey, pwd, {
                            onSuccess: function(contractAddress) {
                                that.status = "Success!";
                                that.contract = contractAddress;
                            },
                            onFailure : function(err) {
                                that.status = "Failed: " + err;
                            }
                        });
                    });
            }
        });

        function deployContractForResource(fromAccount, _coinsPerPlay, _resourceUrl, _resourceKey, pwd, callback) {
            if (!web3.personal.unlockAccount(fromAccount, pwd, 30)) {
                callback.onFailure("Invalid password");
                return;
            }

            var payperplayContract = web3.eth.contract([{"constant":true,"inputs":[],"name":"resourceUrl","outputs":[{"name":"","type":"string"}],"type":"function"},{"constant":true,"inputs":[],"name":"coinsPerPlay","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":false,"inputs":[],"name":"play","outputs":[{"name":"url","type":"string"},{"name":"key","type":"string"}],"type":"function"},{"inputs":[{"name":"_coinsPerPlay","type":"uint256"},{"name":"_resourceUrl","type":"string"},{"name":"_resourceKey","type":"string"}],"type":"constructor"}]);
            var payperplay = payperplayContract.new(
                    _coinsPerPlay,
                    _resourceUrl,
                    _resourceKey,
                    {
                        from: fromAccount,
                        data: '0x60606040526040516106a23803806106a2833981016040528080519060200190919080518201919060200180518201919060200150505b33600060006101000a81548173ffffffffffffffffffffffffffffffffffffffff02191690830217905550826001600050819055508160026000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106100ba57805160ff19168380011785556100eb565b828001600101855582156100eb579182015b828111156100ea5782518260005055916020019190600101906100cc565b5b50905061011691906100f8565b8082111561011257600081815060009055506001016100f8565b5090565b50508060036000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061016757805160ff1916838001178555610198565b82800160010185558215610198579182015b82811115610197578251826000505591602001919060010190610179565b5b5090506101c391906101a5565b808211156101bf57600081815060009055506001016101a5565b5090565b50505b5050506104cb806101d76000396000f36060604052361561005e576000357c01000000000000000000000000000000000000000000000000000000009004806305e91fbc1461006b578063541b9581146100e65780638da5cb5b1461010957806393e84cd9146101425761005e565b6100695b610002565b565b005b610078600480505061021c565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f1680156100d85780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6100f360048050506102bd565b6040518082815260200191505060405180910390f35b61011660048050506102c6565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b61014f60048050506102ec565b6040518080602001806020018381038352858181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f1680156101b35780820380516001836020036101000a031916815260200191505b508381038252848181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f16801561020c5780820380516001836020036101000a031916815260200191505b5094505050505060405180910390f35b60026000508054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156102b55780601f1061028a576101008083540402835291602001916102b5565b820191906000526020600020905b81548152906001019060200180831161029857829003601f168201915b505050505081565b60016000505481565b600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60206040519081016040528060008152602001506020604051908101604052806000815260200150600060016000505434101561032857610002565b6001600050543403905060008111801561037157503373ffffffffffffffffffffffffffffffffffffffff16600082604051809050600060405180830381858888f19350505050155b1561037b57610002565b60026000506003600050818054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561041a5780601f106103ef5761010080835404028352916020019161041a565b820191906000526020600020905b8154815290600101906020018083116103fd57829003601f168201915b50505050509150808054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156104b65780601f1061048b576101008083540402835291602001916104b6565b820191906000526020600020905b81548152906001019060200180831161049957829003601f168201915b50505050509050925092506104c6565b50909156',
                        gas: 5000000
                    }, function (e, contract){
                        if (e) {
                            callback.onFailure(e);
                            return;
                        }
                        console.log(e, contract);
                        if (typeof contract.address !== 'undefined') {
                            callback.onSuccess(contract.address);
                            console.log('Contract mined! address: ' + contract.address + ' transactionHash: ' + contract.transactionHash);
                        }
                        else {
                            callback.onFailure("No address, waiting for another call");
                        }
                    })
        }

        function deployDummy(fromAccount, _coinsPerPlay, _resourceUrl, _resourceKey, pwd, callback) {
            if (!web3.personal.unlockAccount(fromAccount, pwd, 30)) {
                callback.onFailure("Invalid password");
                return;
            }
            var _resourceUrl = "resourceUrl" ;
            var _resourceKey = "resourceKey" ;
            var payperplayContract = web3.eth.contract([{"constant":true,"inputs":[],"name":"resourceUrl","outputs":[{"name":"","type":"string"}],"type":"function"},{"constant":true,"inputs":[],"name":"coinsPerPlay","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":false,"inputs":[],"name":"play","outputs":[{"name":"url","type":"string"},{"name":"key","type":"string"}],"type":"function"},{"inputs":[{"name":"_resourceUrl","type":"string"},{"name":"_resourceKey","type":"string"}],"type":"constructor"}]);
            payperplayContract.new(
                    _resourceUrl,
                    _resourceKey,
                    {
                        from: web3.eth.accounts[0],
                        data: '0x6060604052604051610699380380610699833981016040528080518201919060200180518201919060200150505b33600060006101000a81548173ffffffffffffffffffffffffffffffffffffffff0219169083021790555060016001600050819055508160026000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106100b257805160ff19168380011785556100e3565b828001600101855582156100e3579182015b828111156100e25782518260005055916020019190600101906100c4565b5b50905061010e91906100f0565b8082111561010a57600081815060009055506001016100f0565b5090565b50508060036000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061015f57805160ff1916838001178555610190565b82800160010185558215610190579182015b8281111561018f578251826000505591602001919060010190610171565b5b5090506101bb919061019d565b808211156101b7576000818150600090555060010161019d565b5090565b50505b50506104cb806101ce6000396000f36060604052361561005e576000357c01000000000000000000000000000000000000000000000000000000009004806305e91fbc1461006b578063541b9581146100e65780638da5cb5b1461010957806393e84cd9146101425761005e565b6100695b610002565b565b005b610078600480505061021c565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f1680156100d85780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6100f360048050506102bd565b6040518082815260200191505060405180910390f35b61011660048050506102c6565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b61014f60048050506102ec565b6040518080602001806020018381038352858181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f1680156101b35780820380516001836020036101000a031916815260200191505b508381038252848181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f16801561020c5780820380516001836020036101000a031916815260200191505b5094505050505060405180910390f35b60026000508054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156102b55780601f1061028a576101008083540402835291602001916102b5565b820191906000526020600020905b81548152906001019060200180831161029857829003601f168201915b505050505081565b60016000505481565b600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60206040519081016040528060008152602001506020604051908101604052806000815260200150600060016000505434101561032857610002565b6001600050543403905060008111801561037157503373ffffffffffffffffffffffffffffffffffffffff16600082604051809050600060405180830381858888f19350505050155b1561037b57610002565b60026000506003600050818054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561041a5780601f106103ef5761010080835404028352916020019161041a565b820191906000526020600020905b8154815290600101906020018083116103fd57829003601f168201915b50505050509150808054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156104b65780601f1061048b576101008083540402835291602001916104b6565b820191906000526020600020905b81548152906001019060200180831161049957829003601f168201915b50505050509050925092506104c6565b50909156',
                        gas: 5000000
                    }, function (e, contract){
                        console.log(e, contract);
                        if (typeof contract.address !== 'undefined') {
                            console.log('Contract mined! address: ' + contract.address + ' transactionHash: ' + contract.transactionHash);
                        }
                    })
        }

        function ipfsAdd(caller, path, onSuccess) {
            caller.status = "Loading " + path + "...";
            caller.hash = "Waiting ...";
            var url = "http://localhost:5001/api/v0/add"
            var req = request.post(url, function (err, resp, body) {
                if (err) {
                    caller.status = "Err: " + err;
                } else {
                    var ipfsHash = JSON.parse(body).Hash;
                    caller.hash = ipfsHash;
                    onSuccess(ipfsHash);
                }
            });
            req.form().append('file', fs.createReadStream(path));
        }
    </script>
</dom-module>
