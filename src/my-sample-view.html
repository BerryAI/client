<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-audio-player/paper-audio-player.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">

<dom-module id="my-sample-view">
    <template>
        <style include="shared-styles">
            :host {
                display: block;
                padding: 5px;
                background-color: transparent;
            }
        </style>

        <div class="card">
            <paper-input id="file" label="file" type="file"></paper-input>
            <paper-input type=password id="pwd" label="account pwd"></paper-input>
            <paper-input id="gas" label="gas"></paper-input>

            <paper-button raised on-tap="deploy">Deploy</paper-button>
            <paper-button raised on-tap="test">Test</paper-button>
            <p>ipfs hash: {{hash}}</p>
            <p>tx: {{tx}}</p>
            <p>contract: {{contract}}</p>
            <p>status: {{status}}</p>
            <p>gas estimate: {{estimatedGas}}</p>
        </div>

        <!--<p>status: {{status}}</p>-->
    </template>

    <script>
        var request = require('request');
        var fs = require('fs');
        var Web3 = require('web3');
        var web3 = new Web3();
        var deployed;
        web3.setProvider(new web3.providers.HttpProvider('http://localhost:8545'));

        var abi = [{"constant":true,"inputs":[],"name":"getSomething","outputs":[{"name":"","type":"string"}],"type":"function"},{"constant":true,"inputs":[],"name":"resourceUrl","outputs":[{"name":"","type":"string"}],"type":"function"},{"constant":true,"inputs":[],"name":"getBytes","outputs":[{"name":"","type":"bytes32"}],"type":"function"},{"constant":false,"inputs":[],"name":"kill","outputs":[],"type":"function"},{"constant":true,"inputs":[],"name":"coinsPerPlay","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[{"name":"newValue","type":"string"}],"name":"setResourceUrl","outputs":[],"type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":false,"inputs":[],"name":"play","outputs":[{"name":"url","type":"string"},{"name":"key","type":"string"}],"type":"function"},{"constant":true,"inputs":[],"name":"getResourceUrl","outputs":[{"name":"","type":"string"}],"type":"function"},{"constant":true,"inputs":[],"name":"getNumber","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"inputs":[{"name":"_coinsPerPlay","type":"uint256"},{"name":"_resourceUrl","type":"string"},{"name":"_resourceKey","type":"string"}],"type":"constructor"}]
        var code = "0x6060604052604051610b64380380610b64833981016040528080519060200190919080518201919060200180518201919060200150505b33600060006101000a81548173ffffffffffffffffffffffffffffffffffffffff02191690830217905550826001600050819055508160026000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106100ba57805160ff19168380011785556100eb565b828001600101855582156100eb579182015b828111156100ea5782518260005055916020019190600101906100cc565b5b50905061011691906100f8565b8082111561011257600081815060009055506001016100f8565b5090565b50508060036000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061016757805160ff1916838001178555610198565b82800160010185558215610198579182015b82811115610197578251826000505591602001919060010190610179565b5b5090506101c391906101a5565b808211156101bf57600081815060009055506001016101a5565b5090565b50505b50505061098d806101d76000396000f3606060405236156100a0576000357c01000000000000000000000000000000000000000000000000000000009004806301ec3b6c146100ad57806305e91fbc146101285780630bcd3b33146101a357806341c0e1b5146101ca578063541b9581146101d95780638ada9c76146101fc5780638da5cb5b1461025257806393e84cd91461028b578063b3b2e5bb14610365578063f2c9ecd8146103e0576100a0565b6100ab5b610002565b565b005b6100ba6004805050610403565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f16801561011a5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b610135600480505061045b565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f1680156101955780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6101b060048050506104fc565b604051808260001916815260200191505060405180910390f35b6101d7600480505061050e565b005b6101e660048050506105a7565b6040518082815260200191505060405180910390f35b6102506004808035906020019082018035906020019191908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509090919050506105b0565b005b61025f60048050506106bd565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b61029860048050506106e3565b6040518080602001806020018381038352858181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f1680156102fc5780820380516001836020036101000a031916815260200191505b508381038252848181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f1680156103555780820380516001836020036101000a031916815260200191505b5094505050505060405180910390f35b61037260048050506108c2565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f1680156103d25780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6103ed600480505061097e565b6040518082815260200191505060405180910390f35b6020604051908101604052806000815260200150604060405190810160405280600981526020017f736f6d657468696e6700000000000000000000000000000000000000000000008152602001509050610458565b90565b60026000508054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156104f45780601f106104c9576101008083540402835291602001916104f4565b820191906000526020600020905b8154815290600101906020018083116104d757829003601f168201915b505050505081565b60006101bc600102905061050b565b90565b600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614151561056a57610002565b600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16ff5b565b60016000505481565b600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614151561060c57610002565b8060026000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061065b57805160ff191683800117855561068c565b8280016001018555821561068c579182015b8281111561068b57825182600050559160200191906001019061066d565b5b5090506106b79190610699565b808211156106b35760008181506000905550600101610699565b5090565b50505b50565b600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60206040519081016040528060008152602001506020604051908101604052806000815260200150600060016000505434101561071f57610002565b6001600050543403905060008111801561076857503373ffffffffffffffffffffffffffffffffffffffff16600082604051809050600060405180830381858888f19350505050155b1561077257610002565b60026000506003600050818054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156108115780601f106107e657610100808354040283529160200191610811565b820191906000526020600020905b8154815290600101906020018083116107f457829003601f168201915b50505050509150808054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156108ad5780601f10610882576101008083540402835291602001916108ad565b820191906000526020600020905b81548152906001019060200180831161089057829003601f168201915b50505050509050925092506108bd565b509091565b602060405190810160405280600081526020015060026000508054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561096f5780601f106109445761010080835404028352916020019161096f565b820191906000526020600020905b81548152906001019060200180831161095257829003601f168201915b5050505050905061097b565b90565b600061d431905061098a565b9056";

        Polymer({
            is: 'my-sample-view',
            ready : function() {
                this.estimateGas();
            },
            deploy: function() {
                var that = this;
                var path = this.$.file.inputElement.value;
                var gas = parseInt(this.$.gas.value, 10);
                var pwd = that.$.pwd.value;
                var coinsPerPlay = 99;
                var resourceKey = "dogandcatsdontgetalong";
                var fromAccount = web3.eth.accounts[0];
                ipfsAdd(this, path,
                    function(ipfsHash) {
                        that.status = "Added file to IPFS: " + path + ", Deploying contract...";
                        that.hash = ipfsHash;
                        deployContractForResource(fromAccount, gas, coinsPerPlay, "ipfs://" + ipfsHash, resourceKey, pwd, {
                            onSuccess: function(contractAddress) {
                                that.status = "Success!";
                                that.contract = contractAddress;
                            },
                            onFailure : function(err) {
                                that.status = "Failed: " + err;
                            },
                            onTransaction : function(_tx) {
                                that.tx = _tx;
                            },
                            onStatusUpdate : function(msg) {
                                that.status = msg;
                            }
                        });
                    });
            },
            test: function() {
                doTest();
            },

            estimateGas: function() {
                var estimatedGas = web3.eth.estimateGas({
                    from: web3.eth.accounts[0],
                    value:"0x0",
                    data: code,
                    gas: "0x4c4b40"});
                this.estimatedGas = estimatedGas;
                console.log("estimated Gas: " + estimatedGas);
            }
        });

        function doTest() {
            console.log("deployed.address: " + deployed.address);
            console.log("deployed.transactionHash: " + deployed.transactionHash);
        }

        function deployContractForResource(fromAccount, _gas, _coinsPerPlay, _resourceUrl, _resourceKey, pwd, callback) {
            if (!web3.personal.unlockAccount(fromAccount, pwd, 30)) {
                callback.onFailure("Invalid password");
                return;
            }

            var payperplayContract = web3.eth.contract(abi);
            var payperplay = payperplayContract.new(
                    _coinsPerPlay,
                    _resourceUrl,
                    _resourceKey,
                    {
                        from: fromAccount,
                        data: code,
                        gas: _gas
                    }, function (e, contract){
                        if (e) {
                            callback.onFailure(e);
                            console.log(e);
                            return;
                        }
                        if (contract.address) {
                            callback.onSuccess(contract.address);
                            console.log('Contract mined! address: ' + contract.address + ' transactionHash: ' + contract.transactionHash);
                        }
                        else {
                            callback.onTransaction(contract.transactionHash);
                            console.log("Waiting on tx: " + contract.transactionHash);
                            callback.onStatusUpdate("Waiting on tx: " + contract.transactionHash);
                        }
                    });
            deployed = payperplay;
        }

        function deployDummy(fromAccount, _coinsPerPlay, _resourceUrl, _resourceKey, pwd, callback) {
            if (!web3.personal.unlockAccount(fromAccount, pwd, 30)) {
                callback.onFailure("Invalid password");
                return;
            }
            var payperplayContract = web3.eth.contract([{"constant":true,"inputs":[],"name":"resourceUrl","outputs":[{"name":"","type":"string"}],"type":"function"},{"constant":true,"inputs":[],"name":"coinsPerPlay","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":false,"inputs":[],"name":"play","outputs":[{"name":"url","type":"string"},{"name":"key","type":"string"}],"type":"function"},{"inputs":[{"name":"_resourceUrl","type":"string"},{"name":"_resourceKey","type":"string"}],"type":"constructor"}]);
            console.log("Deploying contract synchronously ...");
            var instance = payperplayContract.new(
                    _resourceUrl,
                    _resourceKey,
                    {
                        from: web3.eth.accounts[0],
                        data: '0x6060604052604051610699380380610699833981016040528080518201919060200180518201919060200150505b33600060006101000a81548173ffffffffffffffffffffffffffffffffffffffff0219169083021790555060016001600050819055508160026000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106100b257805160ff19168380011785556100e3565b828001600101855582156100e3579182015b828111156100e25782518260005055916020019190600101906100c4565b5b50905061010e91906100f0565b8082111561010a57600081815060009055506001016100f0565b5090565b50508060036000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061015f57805160ff1916838001178555610190565b82800160010185558215610190579182015b8281111561018f578251826000505591602001919060010190610171565b5b5090506101bb919061019d565b808211156101b7576000818150600090555060010161019d565b5090565b50505b50506104cb806101ce6000396000f36060604052361561005e576000357c01000000000000000000000000000000000000000000000000000000009004806305e91fbc1461006b578063541b9581146100e65780638da5cb5b1461010957806393e84cd9146101425761005e565b6100695b610002565b565b005b610078600480505061021c565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f1680156100d85780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6100f360048050506102bd565b6040518082815260200191505060405180910390f35b61011660048050506102c6565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b61014f60048050506102ec565b6040518080602001806020018381038352858181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f1680156101b35780820380516001836020036101000a031916815260200191505b508381038252848181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f16801561020c5780820380516001836020036101000a031916815260200191505b5094505050505060405180910390f35b60026000508054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156102b55780601f1061028a576101008083540402835291602001916102b5565b820191906000526020600020905b81548152906001019060200180831161029857829003601f168201915b505050505081565b60016000505481565b600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60206040519081016040528060008152602001506020604051908101604052806000815260200150600060016000505434101561032857610002565b6001600050543403905060008111801561037157503373ffffffffffffffffffffffffffffffffffffffff16600082604051809050600060405180830381858888f19350505050155b1561037b57610002565b60026000506003600050818054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561041a5780601f106103ef5761010080835404028352916020019161041a565b820191906000526020600020905b8154815290600101906020018083116103fd57829003601f168201915b50505050509150808054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156104b65780601f1061048b576101008083540402835291602001916104b6565b820191906000526020600020905b81548152906001019060200180831161049957829003601f168201915b50505050509050925092506104c6565b50909156',
                        gas: 5000000
                    });
            console.log("instance.transactionHash: " + instance.transactionHash);
            console.log("instance.address: " + instance.address);
            console.log("instance: " + instance);
            callback.onSuccess(instance.address);
            deployed = instance; // just for debugging
        }

        function ipfsAdd(caller, path, onSuccess) {
            caller.status = "Loading " + path + "...";
            caller.hash = "Waiting ...";
            var url = "http://localhost:5001/api/v0/add"
            var req = request.post(url, function (err, resp, body) {
                if (err) {
                    caller.status = "Err: " + err;
                } else {
                    var ipfsHash = JSON.parse(body).Hash;
                    caller.hash = ipfsHash;
                    onSuccess(ipfsHash);
                }
            });
            req.form().append('file', fs.createReadStream(path));
        }
    </script>
</dom-module>
