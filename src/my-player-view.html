<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-audio-player/paper-audio-player.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<script src="../bower_components/webcomponentsjs/webcomponents-lite.js"></script>

<dom-module id="my-player-view">
    <template>
        <style include="shared-styles" is="custom-sty;e">
            :host {
                display: block;
                height: inherit;
            }

            paper-input.my-class {
                --paper-input-container-color: #333;
            }
        </style>

        <div class="card">
            <paper-input class="my-class" id="contract_id" label="contract_id"></paper-input>
            <paper-input class="my-class" id="pwd" type=password label="account pwd"></paper-input>
            <paper-button raised on-tap="updateAudio">Play</paper-button>
            <paper-button raised on-tap="stopPlaying">Pause</paper-button>
            <p>status: {{status}}</p>
            <paper-audio-player controls autoplay id="player" color="#796E90"></paper-audio-player>
        </div>
    </template>

    <script>
        var request = require('request');
        var fs = require('fs');
        var Web3 = require('web3');
        var web3 = new Web3();
        web3.setProvider(new web3.providers.HttpProvider('http://localhost:8545'));

        // need to get this from the catalog, I think
        var abi = JSON.parse('[{"constant":true,"inputs":[],"name":"resourceUrl","outputs":[{"name":"","type":"string"}],"type":"function"},{"constant":true,"inputs":[],"name":"coinsPerPlay","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":false,"inputs":[],"name":"play","outputs":[{"name":"url","type":"string"},{"name":"key","type":"string"}],"type":"function"},{"inputs":[{"name":"_coinsPerPlay","type":"uint256"},{"name":"_resourceUrl","type":"string"},{"name":"_resourceKey","type":"string"}],"type":"constructor"}]');

        Polymer({
            is: 'my-player-view',
            updateAudio: function() {
                this.playItemById(this.$.contract_id.value);
            },
            playItem: function(e) {
                this.playItemById(e.target.getAttribute('play-id'));
            },
            playItemById: function(id) {
//                var url = id.startsWith("http") ? id : hashToURL(id);
//                playAudioAtUrl(this, this.$.player, url);
                playContractAudio(this, this.$.player, id, getContractAbiFromCatalog(id), this.getUserCredentials());
            },
            getUserCredentials: function() {
                // obviously not how this will work...
                return this.$.pwd.value;
            },
            stopPlaying: function() {
                this.$.player.playPause();
            }
        })

        function getContractAbiFromCatalog(id) {
            // TODO: The abi should be registered with the contract in the catalog
            // The catalog contract abi can be hardcoded into the client.
            return abi;
        }

        function playContractAudio(caller, player, contractAddress, contractAbi, pwd) {
            var ppp = web3.eth.contract(contractAbi).at(contractAddress);
            var resourceUri = ppp.resourceUrl();
            caller.status = "Resolved to resource: " + resourceUri;
            console.log("coinsPerPlay: " + ppp.coinsPerPlay());
            console.log("Resolved to resource: " + resourceUri);
            var url = covnertToUrl(resourceUri);
            if (url) {
                payForPlay(contractAddress, contractAbi, pwd, {
                    onSuccess : function() {
                        playAudioAtUrl(caller, player, url);
                    },
                    onFailure : function(err) {
                        console.log(err)
                        caller.status = msg;
                    },
                    onStatusChange : function(msg) {
                        console.log(msg)
                        caller.status = msg;
                    }
                });
            }
            else {
                console.log("resourceUri could not be resolved: resourceUri='" + resourceUri + "'")
            }
        }

        function covnertToUrl(resourceUri) {
            if (resourceUri.startsWith("ipfs://")) {
                var ipfsHash = resourceUri.substring(7, resourceUri.length);
                return hashToURL(ipfsHash);
            }
            return null;
        }

        function hashToURL(hash) {
            return "http://localhost:8080/ipfs/" + hash;
        }

        function playAudioAtUrl(caller, player, url) {
            caller.status = "Playing " + url;
            player.src = url;
            player.restart();
        }

        function payForPlay(contractAddress, contractAbi, pwd, callback) {
            var account = web3.eth.accounts[0];
            var ppp = web3.eth.contract(contractAbi).at(contractAddress);

            var result = web3.personal.unlockAccount(account, pwd, 2);
            callback.onStatusChange("Unlocked: " + result);
            if (result) {
                callback.onStatusChange("Account unlocked, sending transaction...");
                ppp.play({from: account, value: ppp.coinsPerPlay()}, function (err, expectedTx) {
                    if (err) {
                        callback.onFailure(err);
                        return;
                    }
                    callback.onStatusChange("Waiting for " + expectedTx + " ...");
                    filter = web3.eth.filter('latest');
                    var count = 0;
                    filter.watch(function(error, result) {
                        if (error) console.log("Error: " + error);
                        if (result) console.log("Result: " + result);
                        var receipt = web3.eth.getTransactionReceipt(expectedTx);
                        callback.onStatusChange("Got receipt: " + receipt);
                        if (receipt && receipt.transactionHash == expectedTx) {
                            callback.onSuccess();
                            filter.stopWatching();
                        }

                        if (count++ > 3) {
                            callback.onFailure(new Error("Transaction was not confirmed"));
                            filter.stopWatching();
                        }
                    });
                });
            }
            else {
                callback.onStatusChange("Invalid account number or password...");
            }
        }
    </script>
</dom-module>
